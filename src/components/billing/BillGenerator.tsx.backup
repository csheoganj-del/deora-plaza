"use client"

import { useState, useRef, useEffect } from "react"
import { useReactToPrint } from "react-to-print"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Separator } from "@/components/ui/separator"
import { generateBill, processPayment } from "@/actions/billing"
import { getMenuItems } from "@/actions/menu"
import { updateDocument } from "@/lib/firebase/firestore"
import { InvoiceTemplate } from "./InvoiceTemplate"
import CustomerAutocomplete from "./CustomerAutocomplete"
import DiscountPanel from "./DiscountPanel"
import { calculateBillTotals } from "@/lib/discount-utils"
import { Printer, CreditCard, Banknote, Smartphone, Loader2, Plus, Trash2, X } from "lucide-react"
import { getBusinessSettings } from "@/actions/businessSettings"
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group"
import { Checkbox } from "@/components/ui/checkbox"

type BillGeneratorProps = {
    order: any
    onClose: () => void
    onAddItems?: () => void
}

type SelectedCustomer = {
    id: string
    name: string
    mobileNumber: string
    discountTier: string
    customDiscountPercent?: number
    totalSpent: number
    visitCount: number
    lastVisit: string | null
}

export default function BillGenerator({ order, onClose, onAddItems }: BillGeneratorProps) {
    const [selectedCustomer, setSelectedCustomer] = useState<SelectedCustomer | null>(null)
    const [discountPercent, setDiscountPercent] = useState(0)
    const [amountPaid, setAmountPaid] = useState(0)
    const [bill, setBill] = useState<any>(null)
    const [loading, setLoading] = useState(false)
    const [businessSettings, setBusinessSettings] = useState<any>(null)
    const [loadingBusinessSettings, setLoadingBusinessSettings] = useState(true)
    const [gstEnabled, setGstEnabled] = useState(false)
    const [gstPercentage, setGstPercentage] = useState(5)
    const [orderSource, setOrderSource] = useState('dine-in')
    const [paymentMethod, setPaymentMethod] = useState('cash')

    // Item selector state
    const [showItemSelector, setShowItemSelector] = useState(false)
    const [menuItems, setMenuItems] = useState<any[]>([])
    const [loadingMenu, setLoadingMenu] = useState(false)
    const [localItems, setLocalItems] = useState<any[]>(() => {
        try {
            // Handle case where order.items might be a JSON string
            if (Array.isArray(order.items)) {
                return order.items.map((item: any) => ({ ...item }));
            } else if (typeof order.items === 'string') {
                const parsed = JSON.parse(order.items);
                return Array.isArray(parsed) ? parsed.map((item: any) => ({ ...item })) : [];
            }
            return [];
        } catch (e) {
            console.warn('Failed to parse order.items in BillGenerator backup:', e);
            return [];
        }
    })

    const printRef = useRef<HTMLDivElement>(null)

    const handlePrint = useReactToPrint({
        contentRef: printRef,
    })

    useEffect(() => {
        const fetchSettings = async () => {
            setLoadingBusinessSettings(true)
            const settings = await getBusinessSettings()
            setBusinessSettings(settings)
            setLoadingBusinessSettings(false)
        }
        fetchSettings()
    }, [])

    const fetchMenuItems = async () => {
        setLoadingMenu(true)
        const items = await getMenuItems(order.businessUnit)
        setMenuItems(items)
        setLoadingMenu(false)
    }

    const calculateTotals = () => {
        const subtotal = localItems.reduce((sum: number, item: any) => sum + (item.price * item.quantity), 0)
        return calculateBillTotals(subtotal, discountPercent, gstEnabled ? gstPercentage : 0)
    }

    const handleAddMenuItem = (menuItem: any) => {
        const existingIndex = localItems.findIndex(item => item.menuItemId === menuItem.id)
        if (existingIndex >= 0) {
            // Item already exists, increase quantity
            const newItems = [...localItems]
            newItems[existingIndex].quantity += 1
            setLocalItems(newItems)
        } else {
            // Add new item
            setLocalItems([...localItems, {
                menuItemId: menuItem.id,
                name: menuItem.name,
                price: menuItem.price,
                quantity: 1
            }])
        }
    }

    const handleRemoveItem = (index: number) => {
        setLocalItems(localItems.filter((_, i) => i !== index))
    }

    const handleUpdateQuantity = (index: number, newQuantity: number) => {
        if (newQuantity <= 0) {
            handleRemoveItem(index)
        } else {
            const newItems = [...localItems]
            newItems[index].quantity = newQuantity
            setLocalItems(newItems)
        }
    }

    const totals = calculateTotals()

    const handleGenerateBill = async () => {
        if (!businessSettings) {
            alert("Business settings are not loaded yet. Please wait.")
            return
        }
        setLoading(true)

        // Update order with local items first
        await updateDocument('orders', order.id, {
            items: localItems,
            totalAmount: totals.subtotal
        })

        const result = await generateBill({
            orderId: order.id,
            businessUnit: order.businessUnit,
            customerMobile: selectedCustomer?.mobileNumber,
            customerName: selectedCustomer?.name,
            subtotal: totals.subtotal,
            discountPercent: totals.discountPercent,
            discountAmount: totals.discountAmount,
            gstPercent: totals.gstPercent,
            gstAmount: totals.gstAmount,
            grandTotal: totals.grandTotal,
            source: orderSource,
            address: businessSettings.address,
            items: localItems
        })

        if (result.success) {
            setBill({
                id: result.billId,
                billNumber: result.billNumber,
                orderId: order.id,
                businessUnit: order.businessUnit,
                customerMobile: selectedCustomer?.mobileNumber,
                customerName: selectedCustomer?.name,
                subtotal: totals.subtotal,
                discountPercent: totals.discountPercent,
                discountAmount: totals.discountAmount,
                gstPercent: totals.gstPercent,
                gstAmount: totals.gstAmount,
                grandTotal: totals.grandTotal,
                paymentStatus: 'paid',
                source: orderSource,
                address: businessSettings.address,
                createdAt: new Date(),
                items: localItems
            })
        } else {
            alert("Failed to generate bill")
        }
        setLoading(false)
    }

    const handlePayment = async () => {
        if (!bill) return
        setLoading(true)
        const result = await processPayment(bill.id, paymentMethod, amountPaid || bill.grandTotal)
        if (result.success) {
            alert("Payment successful!")
            onClose()
        } else {
            alert("Payment failed")
        }
        setLoading(false)
    }

    // Payment View
    if (bill) {
        return (
            <div className="p-6">
                <Card className="max-w-md mx-auto">
                    <CardHeader>
                        <CardTitle className="text-center">Payment & Print</CardTitle>
                    </CardHeader>
                    <CardContent className="space-y-4">
                        <div className="flex justify-between items-center bg-green-50 p-4 rounded-lg border border-green-200">
                            <span className="font-medium text-green-800">Total Due</span>
                            <span className="text-2xl font-bold text-green-700">₹{bill.grandTotal.toFixed(2)}</span>
                        </div>

                        <div className="space-y-2">
                            <Label>Amount Paid</Label>
                            <div className="relative">
                                <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 font-bold">₹</span>
                                <Input
                                    type="number"
                                    value={amountPaid || bill.grandTotal}
                                    onChange={(e) => setAmountPaid(parseFloat(e.target.value))}
                                    className="pl-8"
                                />
                            </div>
                        </div>

                        <div className="space-y-2">
                            <Label>Payment Method</Label>
                            <RadioGroup value={paymentMethod} onValueChange={setPaymentMethod} className="grid grid-cols-3 gap-3">
                                <div>
                                    <RadioGroupItem value="cash" id="pay-cash" className="peer sr-only" />
                                    <Label
                                        htmlFor="pay-cash"
                                        className="flex flex-col items-center justify-center rounded-md border-2 border-muted bg-popover p-3 hover:bg-accent peer-data-[state=checked]:border-primary cursor-pointer"
                                    >
                                        <Banknote className="mb-1 h-5 w-5" />
                                        <span className="text-xs">Cash</span>
                                    </Label>
                                </div>
                                <div>
                                    <RadioGroupItem value="upi" id="pay-upi" className="peer sr-only" />
                                    <Label
                                        htmlFor="pay-upi"
                                        className="flex flex-col items-center justify-center rounded-md border-2 border-muted bg-popover p-3 hover:bg-accent peer-data-[state=checked]:border-primary cursor-pointer"
                                    >
                                        <Smartphone className="mb-1 h-5 w-5" />
                                        <span className="text-xs">UPI</span>
                                    </Label>
                                </div>
                                <div>
                                    <RadioGroupItem value="card" id="pay-card" className="peer sr-only" />
                                    <Label
                                        htmlFor="pay-card"
                                        className="flex flex-col items-center justify-center rounded-md border-2 border-muted bg-popover p-3 hover:bg-accent peer-data-[state=checked]:border-primary cursor-pointer"
                                    >
                                        <CreditCard className="mb-1 h-5 w-5" />
                                        <span className="text-xs">Card</span>
                                    </Label>
                                </div>
                            </RadioGroup>
                        </div>

                        <Button onClick={handlePayment} className="w-full" disabled={loading}>
                            {loading && <Loader2 className="h-4 w-4 animate-spin mr-2" />}
                            Confirm Payment
                        </Button>

                        <Button variant="outline" className="w-full" onClick={() => handlePrint()}>
                            <Printer className="mr-2 h-4 w-4" /> Print Invoice
                        </Button>
                    </CardContent>
                </Card>

                <div className="hidden">
                    <InvoiceTemplate ref={printRef} bill={bill} order={order} businessSettings={businessSettings} businessUnit={order.businessUnit} />
                </div>
            </div>
        )
    }

    // Main Billing Form - Compact & Scrollable
    return (
        <div className="max-h-[80vh] overflow-y-auto p-6">
            <div className="max-w-2xl mx-auto space-y-4">
                {/* Order Items Summary */}
                <Card>
                    <CardHeader className="pb-3 flex flex-row items-center justify-between">
                        <CardTitle className="text-base">
                          Order Items ({(() => {
                            try {
                              if (Array.isArray(order.items)) {
                                return order.items.length;
                              } else if (typeof order.items === 'string') {
                                const parsed = JSON.parse(order.items);
                                return Array.isArray(parsed) ? parsed.length : 0;
                              }
                              return 0;
                            } catch (e) {
                              return 0;
                            }
                          })()})
                        </CardTitle>
                        <Button
                            variant="outline"
                            size="sm"
                            onClick={() => {
                                if (onAddItems) {
                                    onAddItems()
                                } else {
                                    alert("To add items: Close this dialog, click on the table, and add more items to the order.")
                                }
                            }}
                        >
                            + Add Items
                        </Button>
                    </CardHeader>
                    <CardContent>
                        <div className="space-y-2 max-h-40 overflow-y-auto">
                            {(() => {
                              try {
                                if (Array.isArray(order.items)) {
                                  return order.items.map((item: any, index: number) => (
                                    <div key={index} className="flex justify-between text-sm py-1 border-b last:border-0">
                                        <span>{item.name} x {item.quantity}</span>
                                        <span className="font-medium">₹{(item.price * item.quantity).toFixed(0)}</span>
                                    </div>
                                  ));
                                } else if (typeof order.items === 'string') {
                                  const parsed = JSON.parse(order.items);
                                  if (Array.isArray(parsed)) {
                                    return parsed.map((item: any, index: number) => (
                                      <div key={index} className="flex justify-between text-sm py-1 border-b last:border-0">
                                          <span>{item.name} x {item.quantity}</span>
                                          <span className="font-medium">₹{(item.price * item.quantity).toFixed(0)}</span>
                                      </div>
                                    ));
                                  }
                                }
                                return null;
                              } catch (e) {
                                console.warn('Failed to parse order.items in backup:', e);
                                return null;
                              }
                            })()}
                        </div>
                    </CardContent>
                </Card>

                {/* Customer Details */}
                <Card>
                    <CardHeader className="pb-3">
                        <CardTitle className="text-base">Customer Details</CardTitle>
                    </CardHeader>
                    <CardContent className="space-y-3">
                        <CustomerAutocomplete onCustomerSelect={(customer) => setSelectedCustomer(customer)} />

                        <div>
                            <Label className="text-sm mb-2 block">Order Source</Label>
                            <div className="grid grid-cols-2 gap-2">
                                {['dine-in', 'takeaway', 'zomato', 'swiggy'].map((source) => (
                                    <Button
                                        key={source}
                                        variant={orderSource === source ? "default" : "outline"}
                                        size="sm"
                                        onClick={() => setOrderSource(source)}
                                        className="capitalize"
                                    >
                                        {source}
                                    </Button>
                                ))}
                            </div>
                        </div>
                    </CardContent>
                </Card>

                {/* Discounts & Taxes */}
                <Card>
                    <CardHeader className="pb-3">
                        <CardTitle className="text-base">Discounts & Taxes</CardTitle>
                    </CardHeader>
                    <CardContent className="space-y-3">
                        <DiscountPanel
                            customerId={selectedCustomer?.mobileNumber}
                            discountPercent={discountPercent}
                            onDiscountChange={setDiscountPercent}
                            subtotal={totals.subtotal}
                        />

                        <div className="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                            <div className="flex items-center gap-2">
                                <Checkbox
                                    id="gst-toggle"
                                    checked={gstEnabled}
                                    onCheckedChange={(checked) => setGstEnabled(checked as boolean)}
                                />
                                <Label htmlFor="gst-toggle" className="cursor-pointer text-sm">Enable GST</Label>
                            </div>
                            {gstEnabled && (
                                <div className="flex items-center gap-2">
                                    <Input
                                        type="number"
                                        value={gstPercentage}
                                        onChange={(e) => setGstPercentage(Number(e.target.value))}
                                        className="w-16 h-8 text-sm"
                                    />
                                    <span className="text-sm">%</span>
                                </div>
                            )}
                        </div>
                    </CardContent>
                </Card>

                {/* Summary & Generate */}
                <Card>
                    <CardContent className="pt-6 space-y-3">
                        <div className="flex justify-between text-sm">
                            <span>Subtotal</span>
                            <span>₹{totals.subtotal.toFixed(2)}</span>
                        </div>

                        {totals.discountPercent > 0 && (
                            <div className="flex justify-between text-sm text-green-600">
                                <span>Discount ({totals.discountPercent}%)</span>
                                <span>-₹{totals.discountAmount.toFixed(2)}</span>
                            </div>
                        )}

                        {gstEnabled && (
                            <div className="flex justify-between text-sm">
                                <span>GST ({gstPercentage}%)</span>
                                <span>₹{totals.gstAmount.toFixed(2)}</span>
                            </div>
                        )}

                        <Separator />

                        <div className="flex justify-between items-center">
                            <span className="font-bold">Grand Total</span>
                            <span className="text-2xl font-bold text-primary">₹{totals.grandTotal.toFixed(2)}</span>
                        </div>

                        <Button
                            className="w-full"
                            onClick={handleGenerateBill}
                            disabled={loading || loadingBusinessSettings || !businessSettings}
                        >
                            {loading && <Loader2 className="h-4 w-4 animate-spin mr-2" />}
                            {loading ? "Processing..." : "Generate Bill & Pay"}
                        </Button>
                    </CardContent>
                </Card>
            </div>
        </div>
    )
}
